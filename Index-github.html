<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nellore Aqua Accounts | Integrated Finance</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Clean loading spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.3"
        }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Wallet, FileText, Users, Save, ArrowRight, CheckCircle, Plus, ArrowLeft } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- CONFIGURATION ---
        const supabaseUrl = 'https://wlntnttsliaygrqhfazj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbnRudHRzbGlheWdycWhmYXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzMzNjIsImV4cCI6MjA4MDQwOTM2Mn0.imoQLKoDxDVOmKbLOHVDsRxX5jRORMV5cYt2sFf9wiI';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [pendingTrips, setPendingTrips] = useState([]);
            const [selectedTrip, setSelectedTrip] = useState(null);
            const [stats, setStats] = useState({ receivable: 0, payable: 0 });
            
            useEffect(() => {
                fetchPendingTrips();
                fetchLedgerStats();
            }, []);

            const fetchPendingTrips = async () => {
                const { data: trips, error } = await supabase.from('var_truck_trips').select('*').order('tripDate', { ascending: false });
                if(error) console.error("Error fetching trips:", error);
                
                // Get billed IDs
                const { data: billed } = await supabase.from('var_ledger').select('trip_id');
                const billedIds = new Set(billed?.map(b => b.trip_id) || []);
                
                if (trips) {
                    setPendingTrips(trips.filter(t => !billedIds.has(t.id)));
                }
            };

            const fetchLedgerStats = async () => {
                const { data: parties, error } = await supabase.from('var_parties').select('opening_balance');
                if(error) {
                    console.error("Error fetching parties:", error);
                    return; // Fail silently on dashboard if table missing
                }
                if(parties) {
                    let rec = 0; let pay = 0;
                    parties.forEach(p => {
                        const bal = parseFloat(p.opening_balance || 0);
                        if(bal > 0) rec += bal;
                        else pay += Math.abs(bal);
                    });
                    setStats({ receivable: rec, payable: pay });
                }
            };

            return (
                <div className="flex h-screen w-screen overflow-hidden text-slate-800">
                    {/* Sidebar */}
                    <div className="w-64 bg-slate-900 text-white flex flex-col hidden md:flex shadow-2xl z-10">
                        <div className="p-6 border-b border-slate-800">
                            <div className="font-black text-xl tracking-wider text-blue-400">NELLORE AQUA</div>
                            <div className="text-xs text-slate-400 font-medium tracking-widest mt-1">ACCOUNTS MODULE</div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 mt-4">
                            <NavBtn label="Dashboard" icon={<Wallet size={20}/>} active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                            <NavBtn label="Pending Bills" icon={<FileText size={20}/>} active={activeTab === 'billing'} onClick={() => setActiveTab('billing')} count={pendingTrips.length} />
                            <NavBtn label="Parties & Ledger" icon={<Users size={20}/>} active={activeTab === 'parties'} onClick={() => setActiveTab('parties')} />
                        </nav>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 bg-gray-50 overflow-auto relative">
                        {/* Mobile Header */}
                        <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-20">
                            <span className="font-bold">Aqua Accounts</span>
                            <button onClick={() => setActiveTab('dashboard')}><Wallet size={20}/></button>
                        </div>

                        {activeTab === 'dashboard' && <Dashboard stats={stats} pendingCount={pendingTrips.length} switchToBilling={() => setActiveTab('billing')} />}
                        
                        {activeTab === 'billing' && (
                            !selectedTrip 
                            ? <PendingList trips={pendingTrips} onSelect={setSelectedTrip} />
                            : <InvoiceGenerator trip={selectedTrip} onBack={() => { setSelectedTrip(null); fetchPendingTrips(); fetchLedgerStats(); }} />
                        )}
                        
                        {activeTab === 'parties' && <PartyManager />}
                    </div>
                </div>
            );
        };

        const NavBtn = ({ label, icon, active, onClick, count }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-between px-4 py-3 rounded-lg transition-all duration-200 ${active ? 'bg-blue-600 text-white shadow-lg translate-x-1' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                <div className="flex items-center gap-3">{icon} <span className="font-bold text-sm">{label}</span></div>
                {count > 0 && <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">{count}</span>}
            </button>
        );

        const Dashboard = ({ stats, pendingCount, switchToBilling }) => (
            <div className="p-6 md:p-10 max-w-6xl mx-auto">
                <h1 className="text-3xl font-black text-slate-800 mb-2">Overview</h1>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mt-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-shadow cursor-pointer" onClick={switchToBilling}>
                        <div className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-2">Pending Invoices</div>
                        <div className="text-4xl font-black text-orange-500">{pendingCount}</div>
                        <div className="text-xs text-gray-500 mt-2">Trips waiting for billing</div>
                    </div>
                    <div className="bg-gradient-to-br from-blue-900 to-blue-800 text-white p-6 rounded-2xl shadow-lg">
                        <div className="text-xs text-blue-200 font-bold uppercase tracking-wider mb-2">Receivables</div>
                        <div className="text-4xl font-black">₹ {stats.receivable.toLocaleString()}</div>
                        <div className="text-xs text-blue-300 mt-2">To be collected</div>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-2">Payables</div>
                        <div className="text-4xl font-black text-slate-800">₹ {stats.payable.toLocaleString()}</div>
                        <div className="text-xs text-gray-500 mt-2">To be paid</div>
                    </div>
                </div>
            </div>
        );

        const PendingList = ({ trips, onSelect }) => (
            <div className="p-6 md:p-10 max-w-4xl mx-auto">
                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><FileText className="text-blue-600"/> Select Trip to Bill</h2>
                {trips.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 bg-white rounded-xl border-2 border-dashed border-gray-200">
                        <CheckCircle size={40} className="text-green-500 mb-4"/>
                        <div className="text-gray-400 font-medium">All caught up! No pending trips.</div>
                    </div>
                ) : (
                    <div className="grid gap-4">
                        {trips.map(trip => (
                            <div key={trip.id} onClick={() => onSelect(trip)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:border-blue-300 hover:shadow-md cursor-pointer transition-all flex justify-between items-center group relative overflow-hidden">
                                <div className="absolute left-0 top-0 bottom-0 w-1 bg-gray-200 group-hover:bg-blue-500 transition-colors"></div>
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide ${trip.operationMode === 'Sales' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{trip.operationMode}</span>
                                        <span className="text-gray-400 text-xs font-mono">#{trip.referenceId || '---'}</span>
                                        <span className="text-gray-500 text-xs font-medium">| {trip.tripDate}</span>
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 group-hover:text-blue-700 transition-colors">{trip.customerName || 'Unknown Party'}</h3>
                                    <div className="text-xs text-gray-500 mt-1">{trip.totalBoxes} Boxes Loaded</div>
                                </div>
                                <div className="pl-4">
                                    <div className="bg-gray-50 text-gray-400 p-2 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-all">
                                        <ArrowRight size={20}/>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        const InvoiceGenerator = ({ trip, onBack }) => {
            const [rows, setRows] = useState([]);
            const [partyList, setPartyList] = useState([]);
            const [selectedPartyId, setSelectedPartyId] = useState('');
            const [loading, setLoading] = useState(false);
            const [discount, setDiscount] = useState(0);
            const [amountReceived, setAmountReceived] = useState(0);

            useEffect(() => {
                fetchParties();
                // Parse Items
                let initialItems = [];
                if (trip.detailedItems) {
                    initialItems = trip.detailedItems.map(i => ({ name: i.name, boxes: Number(i.boxes) || 0, loose: Number(i.looseKg) || 0, stdWeight: 35, price: 0 }));
                } else if (trip.summary) {
                    initialItems = Object.entries(trip.summary).filter(([k]) => !k.startsWith('__')).map(([k, v]) => ({ name: k, boxes: Number(v), loose: 0, stdWeight: 35, price: 0 }));
                }
                setRows(initialItems);
            }, [trip]);

            const fetchParties = async () => {
                const { data, error } = await supabase.from('var_parties').select('*').order('name');
                if (error) {
                    console.error("Error fetching parties:", error);
                    alert("System Error: Could not fetch parties. Have you run the SQL script?");
                } else {
                    setPartyList(data || []);
                    // Auto-select if name matches
                    if (data && trip.customerName) {
                        const match = data.find(p => p.name.toLowerCase() === trip.customerName.toLowerCase());
                        if (match) setSelectedPartyId(match.id);
                    }
                }
            };

            const calculatedRows = useMemo(() => {
                return rows.map(row => {
                    const weight = (row.boxes * parseFloat(row.stdWeight || 0)) + row.loose;
                    const total = weight * parseFloat(row.price || 0);
                    return { ...row, weight, total };
                });
            }, [rows]);

            const subTotal = calculatedRows.reduce((sum, r) => sum + r.total, 0);
            const grandTotal = subTotal - parseFloat(discount || 0);

            const updateRow = (index, field, value) => {
                const newRows = [...rows];
                newRows[index][field] = value;
                setRows(newRows);
            };

            // --- FIXED: ADD NEW PARTY ---
            const addNewParty = async () => {
                const name = prompt("Enter new Party Name:");
                if (!name) return;

                setLoading(true);
                // Explicitly setting opening_balance to 0 and type to Customer
                const { data, error } = await supabase
                    .from('var_parties')
                    .insert([{ name: name, type: 'Customer', opening_balance: 0 }])
                    .select()
                    .single();

                setLoading(false);

                if (error) {
                    console.error(error);
                    alert(`Error creating party: ${error.message}\nTip: Check if table 'var_parties' exists.`);
                } else if (data) {
                    setPartyList([...partyList, data]);
                    setSelectedPartyId(data.id);
                    alert("Party created successfully!");
                }
            };

            // --- FIXED: SAVE INVOICE ---
            const handleSave = async () => {
                if (!selectedPartyId) return alert("Please select or create a Party.");
                if (grandTotal <= 0) return alert("Total cannot be zero.");
                
                setLoading(true);
                try {
                    // 1. Ledger Entry
                    const { data: ledgerEntry, error: lErr } = await supabase.from('var_ledger').insert([{
                        party_id: selectedPartyId, 
                        trip_id: trip.id, 
                        transaction_date: new Date(),
                        description: `Bill Ref #${trip.referenceId}`, 
                        bill_amount: grandTotal,
                        paid_amount: amountReceived, 
                        discount: discount, 
                        balance_after: 0
                    }]).select().single();

                    if (lErr) throw new Error("Ledger Save Failed: " + lErr.message);

                    // 2. Line Items
                    const lineItems = calculatedRows.map(r => ({
                        ledger_id: ledgerEntry.id, 
                        item_name: r.name, 
                        boxes: r.boxes, 
                        loose_kg: r.loose,
                        std_weight: r.stdWeight, 
                        price_per_kg: r.price, 
                        total_weight: r.weight, 
                        line_total: r.total
                    }));
                    
                    const { error: iErr } = await supabase.from('var_invoice_items').insert(lineItems);
                    if (iErr) throw new Error("Items Save Failed: " + iErr.message);

                    // 3. Update Party Balance
                    const { data: party } = await supabase.from('var_parties').select('opening_balance').eq('id', selectedPartyId).single();
                    let currentBal = parseFloat(party.opening_balance || 0);
                    const netChange = grandTotal - amountReceived;
                    // Sales = They owe us more (+)
                    const finalBal = trip.operationMode === 'Sales' ? currentBal + netChange : currentBal - netChange;
                    
                    const { error: pErr } = await supabase.from('var_parties').update({ opening_balance: finalBal }).eq('id', selectedPartyId);
                    if (pErr) throw new Error("Balance Update Failed: " + pErr.message);

                    alert("Invoice Saved Successfully!");
                    onBack();
                } catch (e) { 
                    console.error(e);
                    alert("Error: " + e.message); 
                } finally { 
                    setLoading(false); 
                }
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    {/* Header */}
                    <div className="flex items-center gap-4 px-6 py-4 border-b bg-white sticky top-0 z-10">
                        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full text-slate-500"><ArrowLeft size={20}/></button>
                        <div>
                            <h2 className="text-xl font-black text-slate-800">Generate Invoice</h2>
                            <div className="text-xs text-gray-500 font-mono">Ref: {trip.referenceId} | {trip.tripDate}</div>
                        </div>
                        <div className="ml-auto flex items-center gap-2">
                            <select className="border-2 border-gray-200 focus:border-blue-500 p-2 rounded-lg font-bold text-sm min-w-[200px] outline-none" value={selectedPartyId} onChange={e => setSelectedPartyId(e.target.value)}>
                                <option value="">-- Select Party --</option>
                                {partyList.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <button onClick={addNewParty} className="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100"><Plus size={20}/></button>
                        </div>
                    </div>

                    {/* Table Area */}
                    <div className="flex-1 overflow-auto p-6">
                        <table className="w-full text-sm text-left border-collapse">
                            <thead>
                                <tr className="text-gray-400 border-b-2 border-gray-100 text-xs uppercase tracking-wider">
                                    <th className="p-3 font-bold">Fish Name</th>
                                    <th className="p-3 text-center">Boxes</th>
                                    <th className="p-3 text-center w-24">Std Wt (35)</th>
                                    <th className="p-3 text-center">Loose Kg</th>
                                    <th className="p-3 text-right">Total Kg</th>
                                    <th className="p-3 text-right w-32">Price/Kg</th>
                                    <th className="p-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {calculatedRows.map((row, idx) => (
                                    <tr key={idx} className="hover:bg-blue-50 transition-colors group">
                                        <td className="p-3 font-bold text-slate-700 text-base">{row.name}</td>
                                        <td className="p-3 text-center text-gray-600 font-medium">{row.boxes}</td>
                                        <td className="p-3">
                                            <input type="number" className="bg-gray-50 border-gray-200 rounded px-2 py-1 w-full text-center font-bold text-gray-500 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                                            value={row.stdWeight} onChange={(e) => updateRow(idx, 'stdWeight', e.target.value)} />
                                        </td>
                                        <td className="p-3 text-center text-gray-500">{row.loose > 0 ? row.loose : '-'}</td>
                                        <td className="p-3 text-right font-mono font-bold bg-gray-50 text-slate-600 rounded">{row.weight.toLocaleString()}</td>
                                        <td className="p-3">
                                            <input type="number" className="border-2 border-gray-200 rounded px-2 py-1.5 w-full text-right font-bold text-lg focus:border-green-500 outline-none transition-all" 
                                            placeholder="0.00" value={row.price} onChange={(e) => updateRow(idx, 'price', e.target.value)} />
                                        </td>
                                        <td className="p-3 text-right font-black text-slate-800 text-lg">{row.total.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Footer / Totals */}
                    <div className="border-t bg-gray-50 p-6">
                        <div className="max-w-xs ml-auto space-y-3">
                            <div className="flex justify-between text-gray-500 text-sm font-medium"><span>Sub Total</span><span>₹{subTotal.toLocaleString()}</span></div>
                            <div className="flex justify-between items-center text-red-500 font-bold text-sm">
                                <span>Discount</span>
                                <input type="number" className="w-24 text-right border-b border-red-200 bg-transparent outline-none focus:border-red-500" value={discount} onChange={e => setDiscount(e.target.value)} />
                            </div>
                            <div className="flex justify-between items-center text-2xl font-black text-slate-800 border-t border-gray-200 pt-3">
                                <span>Grand Total</span>
                                <span>₹{grandTotal.toLocaleString()}</span>
                            </div>
                            <div className="pt-2">
                                <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cash Received</label>
                                <input type="number" className="w-full border-2 border-green-200 bg-green-50 p-2 rounded-lg font-bold text-green-800 focus:border-green-500 outline-none" 
                                placeholder="0.00" value={amountReceived} onChange={e => setAmountReceived(e.target.value)} />
                            </div>
                            <button onClick={handleSave} disabled={loading} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex justify-center items-center gap-2 mt-4">
                                {loading ? <div className="loader"></div> : <><Save size={18}/> Finalize Bill</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PartyManager = () => (
            <div className="flex flex-col items-center justify-center h-full text-center text-gray-400">
                <Users size={64} className="mb-4 opacity-10"/>
                <h2 className="text-2xl font-bold text-gray-300">Party Ledger</h2>
                <p className="mt-2 text-sm">Select a party to view their transaction history.</p>
                <div className="mt-6 px-4 py-2 bg-yellow-50 text-yellow-700 text-xs font-bold rounded-full border border-yellow-100">
                    Feature Coming Soon
                </div>
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
